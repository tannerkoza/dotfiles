#!/bin/sh

### Environment Variables & Constants ###
export KEEP_ZSHRC=yes

SYSTEM_TYPE=$(uname -s)

# colors for msg output
red="\033[91m"
green="\033[92m"
blue="\033[94m"
yellow="\033[93m"
white="\033[97m"
no_color="\033[0m"

### Functions ###
print_header() {
  echo "${green}
       _     _   ___ _ _
     _| |___| |_|  _|_| |___ ___
   _| . | . |  _|  _| | | -_|_ -|
  |_|___|___|_| |_| |_|_|___|___|${yellow}
  BOOTSTRAP SCRIPT
" >&1
}

print_footer() {
  echo "${yellow}
  DOTFILE BOOTSTRAP IS COMPLETE!${red}
  Log out${blue} and${red} login${blue} to apply changes!
"
}

print_msg() {
  echo "${green}=>${no_color}${blue}" "${@}" "${no_color}" >&1
}

install_tmuxinator() { 
  print_msg "installing tmuxinator..."
  sudo gem install tmuxinator
  wget https://raw.githubusercontent.com/tmuxinator/tmuxinator/master/completion/tmuxinator.zsh -O /usr/local/share/zsh/site-functions/_tmuxinator # add zsh completions
}

install_wezterm(){
  print_msg "installing WezTerm..."
  # Import the WezTerm GPG key
curl -fsSL https://apt.fury.io/wez/gpg.key \
  | sudo gpg --dearmor -o /etc/apt/keyrings/wezterm-fury.gpg


# Add the WezTerm repository
echo 'deb [signed-by=/etc/apt/keyrings/wezterm-fury.gpg] https://apt.fury.io/wez/ * *' \
  | sudo tee /etc/apt/sources.list.d/wezterm.list

  sudo apt install wezterm
}
  


install_zsh_plugins() {
  print_msg "installing zsh plugins..."
  git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.zsh}/plugins/zsh-autosuggestions
  git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting
}

install_docker() {
  print_msg "installing docker..."

  if [ -x "$(command -v docker)" ]; then
    print_msg "docker is installed..."
  else
    sudo install -m 0755 -d /etc/apt/keyrings
    sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    sudo chmod a+r /etc/apt/keyrings/docker.asc

    echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  fi
}

install_uv() {
  print_msg "installing uv..."
  curl -LsSf https://astral.sh/uv/install.sh | sh
}

install_lazygit() {
  print_msg "installing lazygit..."
  LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
  curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_arm64.tar.gz"
  tar xf lazygit.tar.gz lazygit
  sudo install lazygit /usr/local/bin
}

update_and_install_packages() {
  if [ "$SYSTEM_TYPE" = "Linux" ]; then
    print_msg "updating and upgrading apt-packages..."
    sudo apt update && sudo apt upgrade

    # install apt-packages from dotfile
    print_msg "installing apt-packages from .apt-packages file..."
    xargs sudo apt-get install -y <~/.config/yadm/.apt-packages
  fi
}

### Execute Commands ###
print_header
update_and_install_packages
install_uv
install_lazygit
install_tmuxinator
install_wezterm

# install docker

install_docker


# install oh-my-zsh with curl
install_zsh_plugins

print_msg "installing oh-my-zsh without overwriting .zshrc..."
sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"

print_footer

